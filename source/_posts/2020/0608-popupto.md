---
title: androidでpop up toを使いこなす
tags:
  - android
categories: 技術
date: 2020-06-08 19:07:24
---


## 背景
こんにちは。[karintomania(twitter)](https://twitter.com/karintozuki)です。  

androidアプリ開発の際に戻るボタンの挙動を制御するため、  
popuptoというプロパティを設定する必要がありますが、  
分かりづらかったので、解説を少々。  
<!-- more -->
## Back Stackについて
androidアプリでは画面遷移のたびに、  
戻るボタンを押した際に遷移するページをバックスタックとして保存しています。  

以下のようなゲームアプリを想定してみます。  
a: タイトル
b: ゲーム画面
c: 結果

{% asset_img 01_pop.png %}

普通にタイトルから、  
ゲーム開始、結果確認、タイトルに戻り再プレイ・・・  
と画面遷移を繰り返すと、  
`a - b - c - a - b - c -...`  
と無限にバックスタックが積まれていってしまいます・

ですが、理想的な動きとしては、  
<u>c - aに戻った際にバックスタックをクリアして欲しい</u>ところです。

また、考慮が漏れがちですが、b - cに画面遷移をする際に
<u>bをバックスタックから削除しておかないと結果画面から直接プレイ画面に戻ってしまいます。</u>  
もちろんアプリの仕様によってはそれもありかもしれませんが、今回はそれを許容しないことにします。  

## Popup to
b - cの実装を先にします。  
{% asset_img 02_b2c.png %}
navigation.xmlをandroid studioで開きます。  

b - c の画面遷移をクリックし、
attribute欄の`popup to`プロパティを設定します。  
{% asset_img 03_popupto.png %}
*画像ではpopUpToInclusiveがTrueになっていますが、Falseになっているのが正しい設定です。  
ここに関しては後述します。  

ここにはバックスタックでどこの画面まで削除したいかを指定します。
今回の場合、<u>aを指定するとa以降にバックスタックに積まれたものが削除されます。</u>  

今回の例では、バックスタックは
`a - b - c`
となっていたので、bが削除され、  
`a - c`
となります。これで結果確認画面で戻るボタンを押した際には、タイトル画面に戻り流ようになりました。  

## popUpToInclusive
c - aの実装もやってみます。  
{% asset_img 04_c2a.png %}

先ほど同様、c - a の画面遷移をクリックし、popUpToにAを指定します。  
これによって画面遷移前には
`c - a`
だったバックスタックがaを残して削除されます。  

しかし、<u>初回のaは削除されないままのため、</u>  
その後にaに画面遷移すると2回目のaもバックスタックに積まれることになり、  
`a - a`
となってしまいます。  

つまり、<u>画面遷移の際に初回のaも削除する必要があります。</u>  

その際に`popUpToInclusive`を指定します。  
こうすることでc - aの画面遷移の際に  
<u>バックスタックが全て削除されます。</u>  

## まとめ
**popUpTo**
指定した画面までのバックスタックを削除する

**popUpToInclusive**
指定した画面を含めてバックスタックを削除する

## 参考
ぜひ公式も参考にしてください。
https://developer.android.com/guide/navigation/navigation-navigate#pop

それでは今日はこの辺で。  